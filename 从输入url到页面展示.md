### 从输入url到页面展示

1. 先看浏览器各个进程之间的主要职责
    - 浏览器进程主要负责用户交互、子进程和文件存储等
    - 网络进程是面向渲染进程和浏览器等提供网络下载
    - 渲染进程的主要职责是把从网络上下载的HTML、Javascript、CSS、图片等资源解析成可以显示和交互的页面。因为渲染进程所有的内容都是通过网络获取的，会存在一些恶意的代码利用浏览器漏洞对系统进行攻击，所以运行在渲染进程里面的代码是不被信任的。这也是为什么Chrome会让渲染进程运行在安全沙箱里，就是为了保证系统安全。


2. 接下来看看输入url到页面显示的整个流程
    - 浏览器进程接收到用户输入的URL请求，浏览器进程便将改URL转发给网络进程
    - 网络进程发起真正的网络请求
    - 网络进程接收到响应头数据，解析响应头数据，并将数据妆发给浏览器进程。
    - 浏览器进程接收到网络进程的响应头数据之后，发送“提交导航（CommitNavigation）” 消息到渲染进程。
    - 渲染进程接收到“提交导航”的消息后，变开始准备接收HTML数据，接收数据的方式是直接合网络进程建立数据管道。
    - 最后渲染进程会向浏览器进程“确认提交”，这是告诉浏览器进程：“已经准备好接收和解析页面数据”。
    - 浏览器进程接收到渲染进程“提交文档”的消息后，便开始溢出之前的旧文档，然后更新浏览器进程中的页面状态。

我们大致清楚以上过程以后，接下来就针对以上步骤一一解读

#### 用户输入

当用户输入时，地址栏会对输入的内容做判断，区分我们是**请求url**还是**搜索内容**。
    - 如果输入内容符合url规则，比如输入www.baidu.com，那么地址栏会根据规则，吧这段内容加上协议，合成完整的url，比如https://www.baidu.com。
    - 如果是搜索内容，地址栏会使用浏览器默认的搜索引擎，来合成新的带搜索关键字的URL


#### URL请求过程

网络进程会查找贝蒂缓存是否缓存了该资源。如果有缓存资源，那么直接返回资源给浏览器进程；如果在缓存中没有查找到资源，那么直接请求网络请求流程。请求前的第一步是要进行DNS解析，以获取请求域名的服务器IP地址。如果请求协议是https,那么还需要建立TLS链接。接下来就是利用IP地址和服务器建立TCP连接。连接建立以后，浏览器会构建请求行、请求头等信息，并把和该域相关的Cookie等数据附加到请求头中，然后想服务器发送构建的请求信息。

服务器接收到请求信息后，会根据请求信息生成响应数据（包括响应行、响应头和响应体等信息），并发送给网络进程。等网络进程接收了响应行和响应头之后，就开始解析响应头的内容。

（1）重定向
    在接收到服务器返回的响应头后，网络进程开始解析响应头，如果发现返回的状态码时**301**或者**302**，那么说明服务器需要浏览器重定向到其他URL这时的网络进程会从响应头的Location字段里面读取重定向的地址，然后再发起新的HTTP或者HTTPS请求，一切重新开始。


在导航过程中，如果服务器响应行的状态码中包含了302、302一类的跳转信息，浏览器会跳转到新的地址继续导航；如果响应行是200，那么标识浏览器可以继续处理请求。

（2）响应数据类型处理

    在处理了跳转信息后，我们继续导航，流程分析。URL请求的数据类型，有时候是一个下载类型，有时候是一个正常的HTML页面，那么浏览器是如何区分他们？
    答案：Content-Type.
    Content-Type 是http请求头中一个非常重要的一个字段，他告诉浏览器返回的响应体数据是什么类型，然后浏览器会根据Content-Type的值来决定如何显示响应体的内容。


比如Content-Type: text/html 他告诉浏览器，服务器daunt返回的数据是HTML格式。如果不是html类型，是别的类型，那么url请求的导航流程结束，但是如果是html，浏览器会继续进行导航流程，由于Chrome 的页面渲染是运行在渲染进程中，接下来就需要准备渲染进程。

（3）准备渲染进程
    默认情况下，Chrome会为每个页面分配一个渲染进程，没打开一个页面的同时，就会配套创建一个新的渲染进程。但是，也有一些例外，在某些情况下，浏览器会让多个页面直接运行在渲染进程中。

    何种情况下，多个页面会同时运行在一个渲染进程中？、

    先看个概念**同一个站点**定义为根域名，加上协议，例如（http://或者https://）,还包含了根域名下的所有子域名和不同的端口，比如

    ```pre
    https:// time.geekbang.org
    https://www.geekbang.org
    https://www.geekbang.org:8000
    ```
他们都是属于同一个站点，因为他们协议都是https，而根域名也都是geekbang.org

Chrome 默认策略是，每个标签对应一个渲染进程。但如果从一个页面打开了另一个新的页面，而新的页面和当前页面属于一个站点的话，那么新页面会复用父页面 的渲染进程。官方把这个默认策略成为（process-per-site-instance）。

渲染进程准备好，还不能立即进入文档解析状态，因为此时的文档数据还在网络进程中，并没有提交给渲染进程，所以下一步就进入了提交文档阶段。

（4）提交文档

    所谓提交文档，就是指浏览器进程将网络进程接收到的HTML数据提交给渲染进程，具体流程如下：
        - 首先当浏览器进程接收到网络进程的响应头之后，便向渲染进程发起“提交文档”的消息。
        - 渲染进程接收到“提交文档”的消息后，会和网络进程建立传输数据的“管道”；
        - 等文本档数据传输完成，渲染进程会返回“确认提交”的消息给浏览器进程；
        - 浏览器进程再收到“确认提交”的消息后，会更新浏览器界面，包括了安全状态、地址栏的URL、前进后退的历史状态，并更新web界面。


（5）渲染阶段

    一旦文档被提交，渲染进程便开始页面解析和子资源加载。